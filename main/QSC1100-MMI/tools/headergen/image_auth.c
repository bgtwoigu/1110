/*=============================================================================

                        Image Authentication Software

GENERAL DESCRIPTION

  This file contains code to implement the Image Authentication Software.
  It will generate three certified output files.

  The tool expects seven arguments as input. The first argument is our
  image.mbn file. The next three arguments are the signature file,
  attestation certificate file and the attestation_ca_cert file.

  The fifth argument is the certificate chain output file. This file gets
  generated by combining the attestation certificate file and the
  attestation_ca_cert file.

  The sixth argument is the qcsbl_all output file. This file gets
  generated by combining the qcsbl.bin file, the signature file and the
  attestation certificate file and the attestation_ca_cert file.


EXTERNALIZED FUNCTIONS


INITIALIZATION AND SEQUENCING REQUIREMENTS
    None.

Copyright (c) 2004, 2005, 2006 by QUALCOMM, Inc.  All Rights Reserved.
=============================================================================*/


/*=============================================================================

                            EDIT HISTORY FOR MODULE

  This section contains comments describing changes made to the module.
  Notice that changes are listed in reverse chronological order.

  $Header: //depot/asic/msmshared/tools/headergen/image_auth.c#2 $

when       who     what, where, why
--------   ---     ------------------------------------------------------------
06/12/06   rjain   Fixed padding bug. Source formatting.
11/04/04   chs     created.


=============================================================================*/


/*=============================================================================

                            INCLUDE FILES FOR MODULE

=============================================================================*/

#include "filetool.h"


/*=============================================================================

            LOCAL DEFINITIONS AND DECLARATIONS FOR MODULE

This section contains local definitions for constants, macros, types,
variables and other items needed by this module.

=============================================================================*/

#undef DBUG_IMAGE_AUTH

/*---------------------------------------------------------------------------

---------------------------------------------------------------------------*/


/*=============================================================================
                              FUNCTION DEFINITIONS

=============================================================================*/

static int create_cert_files (char **, char **);
static int verify_output_file (char *,char **, int);
static int verify_cert_files (char **, char **);



int main (int argc, char *argv[])
{
  uint32 fsize[2];

  /* argument checks. */
  if (argc != 7)
  {
    printf ("USAGE: image_auth binary_file_name signature attestation_cert attestation_ca_cert binary_file_name_cert_chain binary_file_name_all\n");
    return ERROR;
  }

  /* create the certified files. */
  printf("Generating certificate files.\n");
  if (create_cert_files (&argv[1], &argv[5]) == ERROR)
  {
    return ERROR;
  }
  /* verify the certified files. */
  printf("Verifying certificate files.\n");
  if (verify_cert_files (&argv[1], &argv[5]) == ERROR)
  {
    return ERROR;
  }

  printf("All the Certificate files were generated and verified successfully.\n");
  return OK;

} /* main() */


/*===========================================================================

FUNCTION  VERIFY_CERT_FILES

DESCRIPTION

  This function is used to confirm that the output files generated by
  create_cert_files contain valid data. The first argument to the
  function is a pointer to the input file names and the second
  argument is a pointer to the output file names.

  The following is done for all the output files:

  1  It will verify the contents of the output files through the
     verify_output_file function. The verify_output_file function
     will return an ERROR if the output file contains invalid data.

  2  Once the contents is verified, we compare the output file size with
     the input files. We exit immediately if the output file has
     incorrect file size.

DEPENDENCIES
    None.

RETURN VALUE
  ERROR  if verify_output_file returns ERROR or if the output file has
         incorrect file size else
  OK

SIDE EFFECTS
  None.

===========================================================================*/

int verify_cert_files
(
  char **ipfname_ptr,   /* input files.  */
  char **opfname_ptr    /* output files. */
)
{
  uint32 ipfile_size[4];
  uint32 opfile_size[2];
  uint32 sum_file_size = 0;
  int i;

  /* calculate file size of all the input files. */
  for (i = 0; i < 4; i++)
  {
    file_size (ipfname_ptr[i], &ipfile_size[i]);
    sum_file_size += ipfile_size[i];
  }
  /* The output file is padded with zeros, if needed, to ensure
  ** that its size is a multiple of four. Update the sum of input
  ** file sizes to reflect the padding in output file.
  */
  if (( sum_file_size % 4 ) != 0 )
  {
    sum_file_size += ( 4 - ( sum_file_size % 4 ) );
  }

  /* Verify IMAGE_CERTCHAIN output file */
#ifdef DBUG_IMAGE_AUTH
  printf("Verifying %s file....", opfname_ptr[0]);
#endif
  if (verify_output_file (opfname_ptr[0], &ipfname_ptr[2], 2) == ERROR)
  {
    printf("Verification of %s file failed.\n", opfname_ptr[0]);
    return ERROR;
  }

  /* check file size. */
  file_size (opfname_ptr[0], &opfile_size[0]);
  if (opfile_size[0] != (ipfile_size[2] + ipfile_size[3]))
  {
    printf("Verification of %s file failed. Incorrect size.\n", opfname_ptr[0]);
    return ERROR;
  }
#ifdef DBUG_IMAGE_AUTH
  printf("Verification done.\n");
#endif

  /* verify IMAGE_ALL output file */
#ifdef DBUG_IMAGE_AUTH
  printf("Verifying %s file....", opfname_ptr[1]);
#endif
  if (verify_output_file (opfname_ptr[1], &ipfname_ptr[0], 4) == ERROR)
  {
    printf("Verification of %s file failed.\n", opfname_ptr[1]);
    return ERROR;
  }

  /* check file size. */
  file_size (opfname_ptr[1], &opfile_size[1]);
  if ( opfile_size[1] != sum_file_size )
  {
    printf("Verification of %s file failed. Incorrect size.\n", opfname_ptr[1]);
    return ERROR;
  }

#ifdef DBUG_IMAGE_AUTH
  printf("Verification complete.\n");
#endif

  return OK;

} /* verify_cert_files() */


/*===========================================================================

FUNCTION  VERIFY_OUTPUT_FILE

DESCRIPTION

  This is our helper function to verify_cert_files function. The first
  argument to the function is a pointer to the output file name and the
  second argument is a pointer to the input file names.

  The function will compare the contents of the output file with the
  contents of the input files. A successful comparison confirms that
  the output file contains valid data.

DEPENDENCIES
    None.

RETURN VALUE
  ERROR  if file_open failed or if file contains invalid data else
  OK

SIDE EFFECTS
  None.

===========================================================================*/

int verify_output_file
(
  char *opfname_ptr,
  char **ipfname_ptr,
  int  num
)
{
  int i;
  FILE *opfile_ptr, *ipfile_ptr;

  /* open the output file. */
  if (file_open (opfname_ptr, "rb", &opfile_ptr) == ERROR)
  {
    return ERROR;
  }

  for (i = 0; i < num; i++)
  {
    /* open the input file. */
    if (file_open (ipfname_ptr[i], "rb", &ipfile_ptr) == ERROR)
    {
      return ERROR;
    }

    if (file_cmp (opfile_ptr, ipfile_ptr) != 0)
    {
      return ERROR;
    }
    /* close the input file. */
    fclose (ipfile_ptr);
  }
  /* close the output file. */
  fclose (opfile_ptr);

  return OK;

} /* verify_output_file() */


/*===========================================================================

FUNCTION  CREATE_CERT_FILES

DESCRIPTION

  This function is used to create all our certificate files.

  The function expects six arguments as input. The first argument
  is our image.mbn file. The next three arguments are the signature file,
  attestation certificate file and the attestation_ca_cert file.

  The fifth argument is the certificate chain output file. This file gets
  generated by combining the attestation certificate file and the
  attestation_ca_cert file.

  The sixth argument is the image_all output file. This file gets
  generated by combining the image.mbn file, the signature file and the
  attestation certificate file and the attestation_ca_cert file.


DEPENDENCIES
    None.

RETURN VALUE
    ERROR  if file_cpy or file_append_const returns an ERROR else
    OK

SIDE EFFECTS
    Creates the certificate files.

===========================================================================*/

int create_cert_files
(
  char **ipfname_ptr,   /* input file names.  */
  char **opfname_ptr    /* output file names. */
)
{
  int i;
  uint32 ipfile_size[4], opfile_size;
  FILE *ipfile_ptr[4], *opfile_ptr[2];
  int numbytes;

  /* open the output files in write mode. */
  for (i = 0; i < 2; i++)
  {
    if (file_open (opfname_ptr[i], "wb", &opfile_ptr[i]) == ERROR)
    {
      return ERROR;
    }
  }

#ifdef DBUG_IMAGE_AUTH
  printf("Generating all the certificate files.\n");
#endif
  for (i = 0; i < 4; i++)
  {
    /* calculate the file size. */
    file_size (ipfname_ptr[i], &ipfile_size[i]);

    /* open the input file in read mode. */
    if (file_open (ipfname_ptr[i], "rb", &ipfile_ptr[i]) == ERROR)
    {
      return ERROR;
    }
    /* generate image_all */
    if (file_cpy (opfile_ptr[1], ipfile_ptr[i], ipfile_size[i]) == ERROR)
    {
      return ERROR;
    }
  }
  /* generate image_cerchain.mbn */
  for (i = 2; i < 4; i++)
  {
    /* go to the beginning of file. */
    rewind (ipfile_ptr[i]);

    if (file_cpy (opfile_ptr[0], ipfile_ptr[i], ipfile_size[i]) == ERROR)
    {
      return ERROR;
    }
  }

  /* File size must be a multiple of four, append zeros at eof if needed. */
  opfile_size = ftell (opfile_ptr[1]);
  if ((opfile_size % 4) != 0)
  {

    numbytes = 4 - ( opfile_size % 4 );

    if (file_append_const (opfile_ptr[1], 0x0, numbytes) == ERROR)
    {
      return ERROR;
    }
  }

  /* close the input and the output file. */
  for (i = 0; i < 4; i++)
  {
    if (i < 2)
    {
      fclose (opfile_ptr[i]);
    }
    fclose (ipfile_ptr[i]);
  }

  return OK;

} /* create_cert_files() */

